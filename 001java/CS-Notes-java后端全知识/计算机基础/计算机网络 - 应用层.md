# 计算机网络 - 应用层
<!-- GFM-TOC -->
* [计算机网络 - 应用层](#计算机网络---应用层)
    * [域名系统](#域名系统)
    * [文件传送协议](#文件传送协议)
    * [动态主机配置协议](#动态主机配置协议)
    * [远程登录协议](#远程登录协议)
    * [电子邮件协议](#电子邮件协议)
        * [1. SMTP](#1-smtp)
        * [2. POP3](#2-pop3)
        * [3. IMAP](#3-imap)
    * [常用端口](#常用端口)
    * [Web 页面请求过程](#web-页面请求过程)
        * [1. DHCP 配置主机信息](#1-dhcp-配置主机信息)
        * [2. ARP 解析 MAC 地址](#2-arp-解析-mac-地址)
        * [3. DNS 解析域名](#3-dns-解析域名)
        * [4. HTTP 请求页面](#4-http-请求页面)
<!-- GFM-TOC -->


## 域名系统(Domain Name System, DNS)

DNS是一个分布式数据库，提供了主机名和 IP 地址之间相互转换的服务。这里的分布式数据库是指，每个站点只保留它自己的那部分数据。

域名具有层次结构，从上到下依次为：根域名、顶级域名、二级域名。

<div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/b54eeb16-0b0e-484c-be62-306f57c40d77.jpg"/> </div><br>

DNS 可以使用 UDP 或者 TCP 进行传输，使用的**端口号**都为 53。大多数情况下 DNS 使用 UDP 进行传输，这就要求域名解析器和域名服务器都必须自己处理超时和重传从而保证可靠性。在两种情况下会使用 TCP 进行传输：

- 如果返回的响应超过的 512 字节（UDP 最大只支持 512 字节的数据）。
- 区域传送（区域传送是主域名服务器向辅助域名服务器传送变化的那部分数据）。

## 文件传送协议

FTP 使用 TCP 进行连接，它需要两个连接来传送一个文件：

- 控制连接：服务器打开端口号 21 等待客户端的连接，客户端主动建立连接后，使用这个连接将客户端的命令传送给服务器，并传回服务器的应答。
- 数据连接：用来传送一个文件数据。

根据数据连接是否是服务器端主动建立，FTP 有主动和被动两种模式：

- 主动模式：服务器端主动建立数据连接，其中服务器端的端口号为 20，客户端的端口号随机，但是必须大于 1024，因为 0\~1023 是熟知端口号。

<div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/03f47940-3843-4b51-9e42-5dcaff44858b.jpg"/> </div><br>

- 被动模式：客户端主动建立数据连接，其中客户端的端口号由客户端自己指定，服务器端的端口号随机。

<div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/be5c2c61-86d2-4dba-a289-b48ea23219de.jpg"/> </div><br>

主动模式要求客户端开放端口号给服务器端，需要去配置客户端的防火墙。被动模式只需要服务器端开放端口号即可，无需客户端配置防火墙。但是被动模式会导致服务器端的安全性减弱，因为开放了过多的端口号。

## 动态主机配置协议

DHCP (Dynamic Host Configuration Protocol) 提供了即插即用的连网方式，用户不再需要手动配置 IP 地址等信息。

DHCP 配置的内容不仅是 IP 地址，还包括子网掩码、网关 IP 地址。

DHCP 工作过程如下：

1. 客户端发送 Discover 报文，该报文的目的地址为 255.255.255.255:67，源地址为 0.0.0.0:68，被放入 UDP 中，该报文被广播到同一个子网的所有主机上。如果客户端和 DHCP 服务器不在同一个子网，就需要使用中继代理。
2. DHCP 服务器收到 Discover 报文之后，发送 Offer 报文给客户端，该报文包含了客户端所需要的信息。因为客户端可能收到多个 DHCP 服务器提供的信息，因此客户端需要进行选择。
3. 如果客户端选择了某个 DHCP 服务器提供的信息，那么就发送 Request 报文给该 DHCP 服务器。
4. DHCP 服务器发送 Ack 报文，表示客户端此时可以使用提供给它的信息。

<div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/23219e4c-9fc0-4051-b33a-2bd95bf054ab.jpg"/> </div><br>

## 远程登录协议(telnet protocol)

TELNET 用于登录到远程主机上，并且远程主机上的输出也会返回。

TELNET 可以适应许多计算机和操作系统的差异，例如不同操作系统系统的换行符定义。

## 电子邮件协议

一个电子邮件系统由三部分组成：用户代理、邮件服务器以及邮件协议。

邮件协议包含发送协议和读取协议，发送协议常用 SMTP，读取协议常用 POP3 和 IMAP。

<div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/7b3efa99-d306-4982-8cfb-e7153c33aab4.png" width="700"/> </div><br>

### 1. SMTP

SMTP 只能发送 ASCII 码，而互联网邮件扩充 MIME 可以发送二进制文件。MIME 并没有改动或者取代 SMTP，而是增加邮件主体的结构，定义了非 ASCII 码的编码规则。

<div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/ed5522bb-3a60-481c-8654-43e7195a48fe.png" width=""/> </div><br>

### 2. POP3

POP3 的特点是只要用户从服务器上读取了邮件，就把该邮件删除。但最新版本的 POP3 可以不删除邮件。

### 3. IMAP

IMAP 协议中客户端和服务器上的邮件保持同步，如果不手动删除邮件，那么服务器上的邮件也不会被删除。IMAP 这种做法可以让用户随时随地去访问服务器上的邮件。

## 常用端口

|应用| 应用层协议 | 端口号 | 传输层协议 | 备注 |
| :---: | :--: | :--: | :--: | :--: |
| 域名解析 | DNS | 53 | UDP/TCP | 长度超过 512 字节时使用 TCP |
| 动态主机配置协议 | DHCP | 67/68 | UDP | |
| 简单网络管理协议 | SNMP | 161/162 | UDP | |
| 文件传送协议 | FTP | 20/21 | TCP | 控制连接 21，数据连接 20 |
| 远程终端协议 | TELNET | 23 | TCP | |
| 超文本传送协议 | HTTP | 80 | TCP | |
| 简单邮件传送协议 | SMTP | 25 | TCP | |
| 邮件读取协议 | POP3 | 110 | TCP | |
| 网际报文存取协议 | IMAP | 143 | TCP | |

## Web 页面请求过程(可参见https://blog.csdn.net/wenyun_kang/article/details/81290904)

（斜体部分是解释的内容，能帮助理解）

## 前言：整体过程

*一句话过程：*打开浏览器，输入URL，连接服务器，渲染服务器返回的结果。

本地主机与服务器间的通信是两个进程间相互发送报文，而进程是通过socket套接字发送和接收报文的，想要收发socket，首先主机与服务器需要通过TCP三次握手建立TCP连接，连接建立之后，把请求报文放入套接字，然后经过传输层、网络层、数据链路层，层层封装，最终经过以太网路由转发给目的服务器；
服务器收到请求后，返回响应报文，本地主机接收到响应报文之后，经由浏览器渲染展示。
那在这个过程中首先我们需要建立连接，也就是TCP三次握手，先开始第一次握手，也就是主机向服务器发送请求报文段，这就需要知道源IP，目的IP。
一开始，我们没有源IP，现在开始申请IP

## 一、为主机申请IP：DHCP动态主机配置协议

我需要一个IP地址，告诉网络我是谁。这就需要DHCP动态主机配置协议。
1）主机生成一个DHCP请求报文（应用层）
2）放入UDP报文段（传输层），UDP报文段主要包含

源端口68（DHCP客户端的固定端口）
目的端口67（DHCP服务器的固定端口）
3）网络层添加头部封装成IP数据报，主要包含

源IP地址：0.0.0.0
目的IP地址：255.255.255.255（广播IP地址）
4）数据链路层添加头部封装成以太网帧，主要包含

源MAC地址：自己的MAC地址 xx:xx:xx:xx:xx:xx
目的MAC地址：FF:FF:FF:FF:FF:FF（广播帧）
5）以太网帧被发送到交换机*（他是怎么找到交换机的呢？你的网线连着呢呀）*，交换机修改转发表记录我的MAC （自学习：每接收到一个帧都记录该帧的MAC和到达的接口），然后在他的所有出口广播这个帧

6）与交换机相连的默认网关路由器接收到了这个广播帧，进行解析，提取出IP数据报，发现目的IP是广播IP，就交给传输层，传输层又提取出 DHCP 请求交给应用层， DHCP 服务器就收到了该 DHCP 请求。
（路由器？服务器？这里路由器怎么就成服务器了呢？其实路由器的路由功能只是它众多功能的一种，他还可以支持别的协议，比如这里的DHCP协议）

7）DHCP 服务器为此生成一个 DHCP ACK 报文，主要包含：

分配给DHCP请求的IP
DNS服务器的IP
默认网关路由器的IP(网关就是具有路由功能的路由器、服务器,网关IP就是路由器IP)
子网掩码
这个报文再被传输层、网络层、数据链路层一路封装成帧，该帧的目的 MAC 是我的MAC，源MAC是接收 DHCP 请求帧的路由器端口的 MAC

8）DHCP ACK以太网帧由默认网关路由器发送给交换机，交换机根据转发表转发回给我的主机

9）主机收到该帧之后再从链路层到应用层，层层提取，最后得到自己的IP、DNS服务器IP、默认网关路由器IP，进行配置，我就有了IP。

## 二、查找默认网关路由器的MAC地址：ARP地址转换协议(Address Resolution Protocol,处于网路层)

现在我有了源 IP，要开始找目的 IP，现在我已知什么呢？已知目的域名，根据域名找 IP，找 DNS 域名系统服务器去查就好。在前面 DHCP 过程中我们已经得到了 DNS 服务器的 IP 地址，现在只要去访问该IP就好，但是在这之前我们需要先走出我们所处的局域网，这就需要局域网默认网关路由器的MAC地址，这是为什么呢？又要怎么找呢？继续往下看。

先解释一下默认网关路由器，每一个主机都在一个局域网里，要访问局域网以外的主机就需要先离开这个局域网，那我们要怎么离开呢？我们把这个局域网比作一个院子，网关路由器就是这个院子的门，我们要离开这个院子的话就要从门出去，那一个院子可以有很多个门，我们从哪个门出去呢？我们自己也不知道啊，但一般都有一个默认的，不知道该从哪出去的时候，就走默认的。

为什么需要局域网的MAC地址呢？ 因为局域网内是通过 MAC 进行识别的，为什么要用 MAC 地址识别呢？是这样的，以前没这么多主机的时候，IP 是固定的，我们就不需要 MAC，但现在主机越来越多，这就导致局域网里 IP 不是十分充足，管理起来也不是很好管理，所以 IP 每隔一段时间就会被回收，需要的时候才会被分配，这也就是为什么前面提到的 DHCP 动态主机配置协议会存在，所以这个 IP 是会变的，对于主机来说，唯一不变的是 MAC，所以，在局域网内部我们是用 MAC 定位的。

那又要怎么找MAC地址呢？通过IP找MAC，这就用到了ARP地址转换协议。

10）主机生成一个 ARP 查询报文，目的 IP 是默认网关路由器，这个报文最终被封装成以太网帧，帧的目的MAC是 FF:FF:FF:FF:FF:FF（广播地址），然后把帧发给交换机，交换机看到是广播地址就给广播出去

11）默认网关路由器接收到了这个帧，经过层层提取得到 ARP 报文，发现其中的目的 IP 跟他自己某个接口的 IP 匹配，就发送回去一个 ARP 应答报文给主机，这里包含他自己的 MAC

## 三、查找目的域名的IP：DNS域名系统

现在我们(主机从第11步拿到了ARP应答报文)拿到了默认网关路由器的MAC，可以离开局域网去DNS服务器查目的域名的IP了

12）主机生成DNS查询报文，包含

目的域名
DNS服务器目的端口：53
层层封装成以太网帧，帧的目的 MAC 是默认网关路由器的 MAC

13）默认网关路由器接收到该帧之后，提取出IP数据报，并根据路由表进行转发，因为路由器具有内部网关协议*（RIP路由信息协议、OSPF开放最短路径优先协议）和外部网关协议（BGP边界网关协议）*，因此路由表中已经配置了可以从路由器到达 DNS 服务器的路由表项

14）DNS 服务器接收到帧后，层层提取出 DNS 查询报文，并在 DNS 数据库中查找待解析域名对应的 IP，找到之后发送 DNS 应答报文，封装成 UDP 报文段，再放入 IP 数据报，最后通过路由器转回给源主机的默认网关路由器，再经由交换机转发给源主机。

## 四、TCP三次握手

这样我就拿到了目的域名的IP，就可以进行TCP的三次握手了。

15）（第一次握手）主机向目的服务器发送连接请求报文段，SYN=1，ACK=0，选择一个初始的序号 x。

16）（第二次握手）目的服务器收到连接请求报文段后，如果同意建立连接，则向主机发送连接确认报文段，SYN=1，ACK=1，确认号为 x+1，同时也选择一个初始的序号 y。

17）（第三次握手）主机收到目的服务器的连接确认报文段后，还要向目的服务器发出确认，确认号为 y+1，序号为 x+1。

18）目的服务器收到主机的确认后，连接就建立了。

为什么要进行第三次握手呢？
第三次握手是为了防止失效的连接请求到达服务器，让服务器错误打开连接。
客户端发送的连接请求如果在网络中滞留，那么就会隔很长一段时间才能收到服务器端发回的连接确认。客户端等待一个超时重传时间之后，就会重新请求连接。但是这个滞留的连接请求最后还是会到达服务器，如果不进行三次握手，那么服务器就会打开两个连接。如果有第三次握手，客户端会忽略服务器之后发送的对滞留连接请求的连接确认，不进行第三次握手，因此就不会再次打开连接。

19）连接建立完成了，现在我们就可以继续前言中连接建立之后的过程进行访问了

### ~~1. DHCP 配置主机信息~~

- ~~假设主机最开始没有 IP 地址以及其它信息，那么就需要先使用 DHCP 来获取。~~

- ~~主机生成一个 DHCP 请求报文，并将这个报文放入具有目的端口 67 和源端口 68 的 UDP 报文段中。~~

- ~~该报文段则被放入在一个具有广播 IP 目的地址(255.255.255.255) 和源 IP 地址（0.0.0.0）的 IP 数据报中。~~

- ~~该数据报则被放置在 MAC 帧中，该帧具有目的地址 FF:FF:FF:FF:FF:FF，将广播到与交换机连接的所有设备。~~

- ~~连接在交换机的 DHCP 服务器收到广播帧之后，不断地向上分解得到 IP 数据报、UDP 报文段、DHCP 请求报文，之后生成 DHCP ACK 报文，该报文包含以下信息：IP 地址、DNS 服务器的 IP 地址、默认网关路由器的 IP 地址和子网掩码。该报文被放入 UDP 报文段中，UDP 报文段有被放入 IP 数据报中，最后放入 MAC 帧中。~~

- ~~该帧的目的地址是请求主机的 MAC 地址，因为交换机具有自学习能力，之前主机发送了广播帧之后就记录了 MAC 地址到其转发接口的交换表项，因此现在交换机就可以直接知道应该向哪个接口发送该帧。~~

- ~~主机收到该帧后，不断分解得到 DHCP 报文。之后就配置它的 IP 地址、子网掩码和 DNS 服务器的 IP 地址，并在其 IP 转发表中安装默认网关。~~

### ~~2. ARP 解析 MAC 地址(**Media Access Control Address**,媒体访问控制地址、物理地址、硬件地址)~~

- ~~主机通过浏览器生成一个 TCP 套接字，套接字向 HTTP 服务器发送 HTTP 请求。为了生成该套接字，主机需要知道网站的域名对应的 IP 地址。~~

- ~~主机生成一个 DNS 查询报文，该报文具有 53 号端口，因为 DNS 服务器的端口号是 53。~~

- ~~该 DNS 查询报文被放入目的地址为 DNS 服务器 IP 地址的 IP 数据报中。~~

- ~~该 IP 数据报被放入一个以太网帧中，该帧将发送到网关路由器。~~

- ~~DHCP 过程只知道网关路由器的 IP 地址，为了获取网关路由器的 MAC 地址，需要使用 ARP 协议。~~

- ~~主机生成一个包含目的地址为网关路由器 IP 地址的 ARP 查询报文，将该 ARP 查询报文放入一个具有广播目的地址（FF:FF:FF:FF:FF:FF）的以太网帧中，并向交换机发送该以太网帧，交换机将该帧转发给所有的连接设备，包括网关路由器。~~

- ~~网关路由器接收到该帧后，不断向上分解得到 ARP 报文，发现其中的 IP 地址与其接口的 IP 地址匹配，因此就发送一个 ARP 回答报文，包含了它的 MAC 地址，发回给主机。~~

### ~~3. DNS 解析域名~~

- ~~知道了网关路由器的 MAC 地址之后，就可以继续 DNS 的解析过程了。~~

- ~~网关路由器接收到包含 DNS 查询报文的以太网帧后，抽取出 IP 数据报，并根据转发表决定该 IP 数据报应该转发的路由器。~~

- ~~因为路由器具有内部网关协议（RIP、OSPF）和外部网关协议（BGP）这两种路由选择协议，因此路由表中已经配置了网关路由器到达 DNS 服务器的路由表项。~~

- ~~到达 DNS 服务器之后，DNS 服务器抽取出 DNS 查询报文，并在 DNS 数据库中查找待解析的域名。~~

- ~~找到 DNS 记录之后，发送 DNS 回答报文，将该回答报文放入 UDP 报文段中，然后放入 IP 数据报中，通过路由器反向转发回网关路由器，并经过以太网交换机到达主机。~~

### ~~4. HTTP 请求页面~~

- ~~有了 HTTP 服务器的 IP 地址之后，主机就能够生成 TCP 套接字，该套接字将用于向 Web 服务器发送 HTTP GET 报文。~~

- ~~在生成 TCP 套接字之前，必须先与 HTTP 服务器进行三次握手来建立连接。生成一个具有目的端口 80 的 TCP SYN 报文段，并向 HTTP 服务器发送该报文段。~~

- ~~HTTP 服务器收到该报文段之后，生成 TCP SYN ACK 报文段，发回给主机。~~

- ~~连接建立之后，浏览器生成 HTTP GET 报文，并交付给 HTTP 服务器。~~

- ~~HTTP 服务器从 TCP 套接字读取 HTTP GET 报文，生成一个 HTTP 响应报文，将 Web 页面内容放入报文主体中，发回给主机。~~

- ~~浏览器收到 HTTP 响应报文后，抽取出 Web 页面内容，之后进行渲染，显示 Web 页面。~~
